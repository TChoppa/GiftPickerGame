@model IEnumerable<SantaGift.Models.Participants>

@{
    ViewData["Title"] = "ParticipantsList";
}

<!-- ===================== CSS ===================== -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

<!-- ===================== JS ===================== -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<h1 class="text-center mt-3">Welcome Dashboard</h1>

<!-- ===================== ADD PARTICIPANT ===================== -->
<div class="container d-flex justify-content-center mt-5">
    <div class="col-md-4">
        <div class="p-4 bg-light border rounded shadow-sm">
            <h4 class="text-center text-primary mb-4">Add Participant</h4>

            <form id="registerForm">
                <div class="mb-3">
                    <label class="form-label">Participant</label>
                    <input type="text" id="Name" class="form-control"
                           required minlength="3" maxlength="20" />
                </div>

                <span id="msgError" class="text-danger"></span>
                <span id="msgSuccess" class="text-success"></span>

                <div class="position-relative mt-4" style="min-height:40px;">
                    <a href="@Url.Action("PlayGame", "PlayGame")"
                       class="position-absolute start-0 top-50 translate-middle-y">
                        Back
                    </a>

                    <button type="submit" id="btnSave"
                            class="btn btn-info position-absolute start-50 translate-middle-x">
                        Save
                    </button>

                    <a href="#" id="listParticipants"
                       class="position-absolute end-0 top-50 translate-middle-y">
                        View
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ===================== MODAL ===================== -->
<div class="modal fade" id="participantsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content shadow-lg rounded-4">

            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title">Participants</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <table class="table table-hover" id="modalUsersTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Edit</th>
                            <th>Delete</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>

                <div id="playMessage" class="text-center text-danger fw-semibold"></div>
            </div>
        </div>
    </div>
</div>

<!-- ===================== SCRIPT ===================== -->
<script>
    // LOAD PARTICIPANTS
    function GetParticipants() {
        $("#modalUsersTable tbody").empty();
        $("#playMessage").text("");

        $.ajax({
            url: "/Dashboard/GetParticipants",
            type: "GET",
            success: function (response) {

                if (response.success === false) {
                    $("#playMessage").text(response.message + " Kindly Create Your Team to Play");
                    return;
                }

                $.each(response, function (i, user) {
                    $("#modalUsersTable tbody").append(
                        `<tr data-id="${user.id}">
                            <td>${user.name}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary editBtn">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-danger deleteBtn">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>`
                    );
                });
            },
            error: function () {
                $("#playMessage").text("Error loading participants");
            }
        });
    }

    // OPEN MODAL
    $("#listParticipants").on("click", function (e) {
        e.preventDefault();
        const modal = new bootstrap.Modal(document.getElementById("participantsModal"));
        modal.show();
        GetParticipants();
    });

    // ADD PARTICIPANT
    $("#btnSave").on("click", function (e) {
        e.preventDefault();

        $.ajax({
            url: "/Dashboard/AddParticipant",
            type: "POST",
            data: { name: $("#Name").val() },
            success: function (response) {
                if (response.success) {
                    $("#msgSuccess").text(response.message);
                    $("#msgError").text("");
                    $("#Name").val("");
                } else {
                    $("#msgError").text(response.message);
                }
            }
        });
    });

    // DELETE
    $("#modalUsersTable").on("click", ".deleteBtn", function () {
        let row = $(this).closest("tr");
        let id = row.data("id");

        $.post("/Dashboard/DeleteParticipant", { id }, function (res) {
            if (res.success) row.remove();
            else alert(res.message);
        });
    });

    // EDIT
    $("#modalUsersTable").on("click", ".editBtn", function () {
        let row = $(this).closest("tr");
        let id = row.data("id");
        let oldName = row.find("td:first").text();

        let input = $("<input class='form-control form-control-sm'>").val(oldName);
        row.find("td:first").html(input);
        input.focus();

        input.on("blur", function () {
            let newName = $(this).val();

            $.post("/Dashboard/EditParticipant",
                { id: id, name: newName },
                function (res) {
                    row.find("td:first").text(res.success ? newName : oldName);
                });
        });
    });
</script>
